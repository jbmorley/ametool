#!/usr/bin/env python

import argparse
import collections
import logging
import os
import pprint
import struct
import sys

verbose = '--verbose' in sys.argv[1:] or '-v' in sys.argv[1:]
logging.basicConfig(level=logging.DEBUG if verbose else logging.INFO, format="[%(levelname)s] %(message)s")


class BinaryReader(object):

    def __init__(self, path):
        self._path = path
        self.fh = open(self._path, mode='rb')

    def string(self, title=""):
        length = self.int()
        string = struct.unpack('%ds' % length, self.fh.read(length))[0]
        return string

    def int(self):
        integer = 0
        shift = 0
        while True:
            current = struct.unpack('B', self.fh.read(1))[0]
            integer |= ((current & 0x7F) << shift)
            if (current & 128 == 0):
                break
            shift += 7
        return integer

    def int32(self):
        return struct.unpack('i', self.fh.read(4))[0]

    def double(self):
        return struct.unpack('d', self.fh.read(8))[0]


def read_metadata(reader):

    assert reader.string() == "MDVersion2"

    intensities = []
    for i in xrange(0, reader.int32()):
        intensity = {}
        intensity['Id'] = i
        intensity['Description'] = reader.string()
        intensity['Units'] = reader.string()
        intensities.append(intensity)

    metadata = {}
    metadata['Intensities'] = intensities
    metadata['Title'] = reader.string()
    metadata['CreationDateNew'] = reader.string()
    metadata['Version'] = reader.string()
    metadata['Abstract'] = reader.string()
    metadata['IndividualName'] = reader.string()
    metadata['Organization'] = reader.string()
    metadata['PositionName'] = reader.string()
    metadata['Phone'] = reader.string()
    metadata['Fax'] = reader.string()
    metadata['Address'] = reader.string()
    metadata['City'] = reader.string()
    metadata['AdministrativeArea'] = reader.string()
    metadata['ZipCode'] = reader.string()
    metadata['Country'] = reader.string()
    metadata['Email'] = reader.string()
    metadata['KeyWord'] = reader.string()
    metadata['AccessConstraints'] = reader.string()
    metadata['UseConstraints'] = reader.string()
    metadata['Language'] = reader.string()
    metadata['CharacterSet'] = reader.string()
    metadata['NorthBound'] = reader.double()
    metadata['SouthBound'] = reader.double()
    metadata['WestBound'] = reader.double()
    metadata['EastBound'] = reader.double()
    metadata['Url'] = reader.string()
    return metadata


def read_ame(reader):

    reader.string("Class")
    metadata = read_metadata(reader)
    return metadata


def main():
    parser = argparse.ArgumentParser(description="Tool for manipulating AME files.")
    parser.add_argument("file", help="AME file")
    options = parser.parse_args()

    amefile = os.path.abspath(options.file)
    logging.info(amefile)

    ame = read_ame(BinaryReader(path=amefile))
    pprint.pprint(ame, indent=2)


if __name__ == "__main__":
    main()
